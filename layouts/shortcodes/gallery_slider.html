{{/* Gallery Slider: renders images from the same sources as the default gallery, but as a Bootstrap carousel. */}}
{{ $album := "" }}
{{ with .Get "album" }}{{ $album = . }}{{ else }}{{ $album = "gallery" }}{{ end }}

{{ $interval := .Get "interval" | default "5000" }}
{{ $height := .Get "height" | default "" }}
{{ $fit := .Get "fit" | default "" }}

{{ $album_path := "" }}
{{ $resource_page := "" }}
{{ if eq .Page.Parent.Type "widget_page" }}
  {{ $album_path = printf "%s/%s/*" (path.Base (path.Split .Page.Path).Dir) $album }}
  {{ $resource_page = $.Page.Parent }}
{{ else }}
  {{ $album_path = printf "%s/*" $album }}
  {{ $resource_page = $.Page }}
{{ end }}

{{ $images := ($resource_page.Resources.ByType "image").Match $album_path }}

{{/* Build slides list from resources, params.gallery_item, or static/img/<album> */}}
{{ $slides := slice }}
{{ if $images }}
  {{ range $images }}
    {{ $img := .Resize "1200x" }}
    {{ $filename := path.Base .Name }}
    {{ $caption := "" }}
    {{ if $.Page.Params.gallery_item }}
      {{ range (where (where $.Page.Params.gallery_item "album" $album) "image" $filename) }}
        {{ $caption = .caption }}
      {{ end }}
    {{ end }}
    {{ $slides = $slides | append (dict "src" $img.RelPermalink "caption" $caption) }}
  {{ end }}
{{ else if $.Page.Params.gallery_item }}
  {{ range (where $.Page.Params.gallery_item "album" $album) }}
    {{ $src := .image }}
    {{ if gt (len .image) 4 }}
      {{ if ne "http" (slicestr .image 0 4) }}
        {{ $src = printf "img/%s" .image | relURL }}
      {{ end }}
    {{ end }}
    {{ $slides = $slides | append (dict "src" $src "caption" .caption) }}
  {{ end }}
{{ else }}
  {{ $staticDir := printf "static/img/%s" $album }}
  {{ if (fileExists $staticDir) }}
    {{ range (readDir $staticDir) }}
      {{ if not .IsDir }}
        {{ $name := .Name | lower }}
        {{ if or (hasSuffix $name ".jpg") (hasSuffix $name ".jpeg") (hasSuffix $name ".png") (hasSuffix $name ".gif") }}
          {{ $src := printf "img/%s/%s" $album .Name | relURL }}
          {{ $slides = $slides | append (dict "src" $src "caption" "") }}
        {{ end }}
      {{ end }}
    {{ end }}
  {{ end }}
{{ end }}

{{ $carouselId := printf "gallery-carousel-%s" ($album | urlize) }}

<div id="{{ $carouselId }}" class="carousel slide" data-ride="carousel" data-interval="{{ $interval }}" data-touch="true">
  {{/* Indicators (dots) */}}
  {{ $count := len $slides }}
  {{ if gt $count 1 }}
  <ol class="carousel-indicators">
    {{ range $index, $_ := $slides }}
      <li data-target="#{{ $carouselId }}" data-slide-to="{{ $index }}" class="{{ if eq $index 0 }}active{{ end }}" {{ if eq $index 0 }}aria-current="true"{{ end }}></li>
    {{ end }}
  </ol>
  {{ end }}
  <div class="carousel-inner">
    {{ $i := 0 }}
    {{ range $slides }}
      {{/* Build optional inline style for height/fit */}}
      {{ $style := "" }}
      {{ if $height }}
        {{ $style = printf "height: %s;" $height }}
        {{ if eq $fit "contain" }}
          {{ $style = printf "%s object-fit: contain; background: #fff;" $style }}
        {{ else if eq $fit "cover" }}
          {{ $style = printf "%s object-fit: cover;" $style }}
        {{ end }}
      {{ end }}
      <div class="carousel-item {{ if eq $i 0 }}active{{ end }}">
        <img class="d-block w-100" src="{{ .src }}" alt="" {{ with $style }}style="{{ . | safeCSS }}"{{ end }}>
        {{ with .caption }}
        <div class="carousel-caption d-none d-md-block">
          <p>{{ . | markdownify | emojify }}</p>
        </div>
        {{ end }}
      </div>
      {{ $i = add $i 1 }}
    {{ end }}
  </div>
  <a class="carousel-control-prev" href="#{{ $carouselId }}" role="button" data-slide="prev">
    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
    <span class="sr-only">Previous</span>
  </a>
  <a class="carousel-control-next" href="#{{ $carouselId }}" role="button" data-slide="next">
    <span class="carousel-control-next-icon" aria-hidden="true"></span>
    <span class="sr-only">Next</span>
  </a>

  {{/* Height now handled inline on the <img> elements to avoid CSS parsing issues with templating */}}
</div>
